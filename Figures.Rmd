---
title: "DMI_ClinVar_AF"
author: "JesusAV"
date: "2025-01-16"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, message = F, warning = F)
```

```{r Packages, echo=F}
library(tidyverse)
library(gridExtra)
library(knitr) 
library(dplyr)
library(ggstats)
library(ggplot2)
library(ggvenn) 
library(ggbeeswarm)
library(corrplot)
library(igraph)
library(networkD3)
library(tools)
```


```{r Palettes}
colors_Var <-c("#56B4E9","#E69F00","#d52221","#999999")
colors_BIN <- c("darkgrey","#006AB4")
colors_DMI <- c("darkgrey","#18974C")
colors_blues <- c("#CADCE8","#66A9D6","#4E93C1","#006AB4","#00548C")
colors_ELMtypes <- c("#734595","#A1BE1F","#F49E17","#3B6FB6","#D41645","#F4C61F")

```


```{r Data_maps}
amino_acid_map <- c(
  Ala = "A", Arg = "R", Asn = "N", Asp = "D", 
  Cys = "C", Gln = "Q", Glu = "E", Gly = "G",
  His = "H", Ile = "I",  Leu = "L", Lys = "K", 
  Met = "M", Phe = "F", Pro = "P",  Ser = "S", 
  Thr = "T", Trp = "W", Tyr = "Y", Val = "V"
  )
```

```{r Figure1_Data}
ClinVar_mutations <- read_csv(file="/Volumes/imb-luckgr/Luck_lab_members/Jesus/DMIs_ClinVar/Datasets/All_DMIs-All_mutations/DDD_and_clinvar_mutations_2023_release.csv", col_names = T)
Disorder_pLDDT <- read_tsv(file="/Volumes/imb-luckgr/imb-luckgr2/projects/AlphaFold/AFDB_HumanReferenceProteome/proteins_pLDDT_values_byResidue.txt", col_names = T)
Disorder_IUPred <- read_tsv(file="/Volumes/imb-luckgr/imb-luckgr2/projects/AlphaFold/AFDB_HumanReferenceProteome/CANO_ISO_SEQUENCES_IUPRed_LONG_disorder_byResidue.txt", col_names = T) %>% rename(UniProt_ID=ID, Residue_n=Residue_N)

ClinVar_mutations <- ClinVar_mutations %>% select(uniprot_id, gene_symbol, aa_change, aa_pos, pathogenicity) %>% unique()
ClinVar_mutations <- ClinVar_mutations %>% mutate(pathogenicity=case_when(pathogenicity=="benign" ~ "Benign",
                                                                          pathogenicity=="conflicting" ~ "Conflicting",
                                                                          pathogenicity=="pathogenic" ~ "Pathogenic",
                                                                          pathogenicity=="uncertain" ~ "Uncertain"))

ClinVar_mut_dis <-  ClinVar_mutations %>% rename(UniProt_ID=uniprot_id, Residue_n=aa_pos) %>% mutate(Residue= amino_acid_map[gsub("[0-9].*?$","",aa_change)] )
ClinVar_mut_dis <- left_join(ClinVar_mut_dis,Disorder_pLDDT,by=c("UniProt_ID","Residue","Residue_n"))
ClinVar_mut_dis <- left_join(ClinVar_mut_dis,Disorder_IUPred,by=c("UniProt_ID","Residue","Residue_n"))
#rm(Disorder_pLDDT,Disorder_IUPred)


ClinVar_mut_dis <- ClinVar_mut_dis %>% group_by(UniProt_ID, gene_symbol, aa_change, Residue_n,pathogenicity,Residue ) %>% 
   summarise(avg_pLDDT = mean(pLDDT_value, na.rm=TRUE), avg_IUPred = mean(IUPred_long, na.rm=TRUE)) %>% ungroup()
```

```{r Figure1_Data2}
#Disorder Thresholds
pLDDT_thrs <- 70
IUPred_thrs <- 0.4

ClinVar_mut_dis <- ClinVar_mut_dis %>% mutate(dis_pLDDT=case_when(avg_pLDDT<pLDDT_thrs ~ 1, avg_pLDDT>=pLDDT_thrs ~ 0  )) %>% mutate(dis_IUPred=case_when(avg_IUPred>=IUPred_thrs ~ 1, avg_IUPred<IUPred_thrs ~ 0 ))


Pathogenicity_pLDDT_table <- ClinVar_mut_dis %>% filter(!is.na(dis_pLDDT)) %>% count(pathogenicity, dis_pLDDT) %>% 
  mutate(Category=case_when(dis_pLDDT==1 ~ "Disorder", dis_pLDDT==0 ~ "Order")) %>% select(-dis_pLDDT)  %>% pivot_wider(names_from = Category, values_from = n, values_fill=0 ) 

Pathogenicity_pLDDT_dt <- as.table(as.matrix(Pathogenicity_pLDDT_table[,2:3]))
rownames(Pathogenicity_pLDDT_dt) <-Pathogenicity_pLDDT_table$pathogenicity
Pathogenicity_pLDDT_chisq <- chisq.test(Pathogenicity_pLDDT_dt)

Pathogenicity_pLDDT_PU_dt <- Pathogenicity_pLDDT_dt[3:4,]
Pathogenicity_pLDDT_PU_chisq <- chisq.test(Pathogenicity_pLDDT_PU_dt)


Pathogenicity_IUPred_table <- ClinVar_mut_dis %>% filter(!is.na(dis_IUPred)) %>% count(pathogenicity, dis_IUPred) %>% 
  mutate(Category=case_when(dis_IUPred==1 ~ "Disorder", dis_IUPred==0 ~ "Order")) %>% select(-dis_IUPred)  %>% pivot_wider(names_from = Category, values_from = n, values_fill=0 ) 

Pathogenicity_IUPred_dt <- as.table(as.matrix(Pathogenicity_IUPred_table[,2:3]))
rownames(Pathogenicity_IUPred_dt) <-Pathogenicity_IUPred_table$pathogenicity
Pathogenicity_IUPred_chisq <- chisq.test(Pathogenicity_IUPred_dt)

Pathogenicity_IUPred_PU_dt <- Pathogenicity_IUPred_dt[3:4,]
Pathogenicity_IUPred_PU_chisq <- chisq.test(Pathogenicity_IUPred_PU_dt)
```


```{r Figure1_Plot_A}
plots_title <- "ClinVar mutation pathogenicitiy"
plots_xlab <- "Clinical relevance"
plots_ylab <- "Mutation number"

p1 <- ggplot(ClinVar_mutations, aes(x=pathogenicity , fill=pathogenicity)) + geom_bar(width = 0.5) +
  ggtitle(plots_title) +  xlab(plots_xlab) + ylab(plots_ylab) + ylim(0, 850000)+
  theme_classic() + scale_fill_manual(values=colors_Var) + labs(fill = "Pathogenicity") +
  theme(text = element_text(size = 20), legend.position = "none", axis.text.x = element_text(angle = 30, vjust = 1, hjust=1)) + 
  scale_y_continuous(labels = scales::comma)

tiff("Figures/Figure1_graphics/ClinVar_mutations.tiff", units="cm", width=10, height=10, res=800)
pdf("Figures/Figure1_graphics/ClinVar_mutations.pdf", width=4, height=4)
p1
dev.off()

p1
p1 +geom_text(aes(label = ..count..), stat = "count", vjust = -2, position = position_dodge(0.9), size = 3.5) +
  geom_text(stat='prop', vjust=-0.5, , position = position_dodge(0.9), size=3)

```

```{r Figure1_Graphic_B}
p1 <- ggplot(ClinVar_mut_dis, aes(x=pathogenicity, y=avg_pLDDT, color=as.factor(pathogenicity))) + 
  geom_quasirandom(size=0.5, alpha=0.4) + geom_boxplot(color="black", width=0.25, outlier.alpha = 0.2) +
  ggtitle("ClinVar mutations pLDDT") + xlab("Pathogenicity") + ylab("Residue pLDDT") + 
  theme_classic()  +  scale_color_manual(values=colors_Var) +
  theme(text = element_text(size = 20), legend.position = "none", legend.title = element_text(size=8), 
        legend.text = element_text(size=8), legend.key.size = unit(0.3, 'cm'), axis.text.x = element_text(angle = 30, vjust = 1, hjust=1)) 

#SAVE TIFF
tiff("Figures/Figure1_graphics/ClinVar_pLDDT.tiff", units="cm", width=10, height=10, res=800)
p1
dev.off()
#SAVE PDF
pdf("Figures/Figure1_graphics/ClinVar_pLDDT.pdf", width=4, height=4)
p1
dev.off()
p1

p2 <- ggplot(ClinVar_mut_dis, aes(x=pathogenicity, y=avg_IUPred, color=as.factor(pathogenicity))) + 
  geom_quasirandom(size=0.5, alpha=0.4) + geom_boxplot(color="black", width=0.25, outlier.alpha = 0.2) +
  ggtitle("ClinVar mutations IUPred") + xlab("Pathogenicity") + ylab("Residue IUPred") + 
  theme_classic()  +  scale_color_manual(values=colors_Var) +
  theme(text = element_text(size = 20), legend.position = "none", legend.title = element_text(size=8), 
        legend.text = element_text(size=8), legend.key.size = unit(0.3, 'cm'), axis.text.x = element_text(angle = 30, vjust = 1, hjust=1)) 

#SAVE TIFF
tiff("Figures/Figure1_graphics/ClinVar_IUPred.tiff", units="cm", width=10, height=10, res=800)
p2
dev.off()
#SAVE PDF
pdf("Figures/Figure1_graphics/ClinVar_IUPred.pdf", width=4, height=4)
p2
dev.off()
p2
#rm (p1,p2)
```

```{r Figure1_Graphic_C1}
### Correlations plots - pLDDT classification

Pathogenicity_pLDDT_chisq$residuals
Pathogenicity_pLDDT_chisq$observed
#SAVE TIFF
tiff("Figures/Figure1_graphics/ClinVar_pLDDT_disorder_chisq.tiff", units="cm", width=10, height=20, res=800)
corrplot(Pathogenicity_pLDDT_chisq$residuals, method = 'color', is.corr  = FALSE, col = rev(COL2('RdBu')), 
         cl.pos = 'b', addCoef.col = 'grey50', number.cex = 0.01, col.lim= c(-80, 80))
dev.off()
#SAVE PDF
pdf("Figures/Figure1_graphics/ClinVar_pLDDT_disorder_chisq.pdf", width=4, height=8)
corrplot(Pathogenicity_pLDDT_chisq$residuals, method = 'color', is.corr  = FALSE, col = rev(COL2('RdBu')), 
         cl.pos = 'b', addCoef.col = 'grey50', number.cex = 0.01, col.lim= c(-80, 80))
dev.off()

#corrplot(Pathogenicity_pLDDT_chisq$observed,  method = 'color', is.corr   = FALSE, col = rev(COL2('RdBu')), cl.pos = 'b', addCoef.col = 'grey50')

Pathogenicity_pLDDT_PU_chisq$residuals
Pathogenicity_pLDDT_PU_chisq$observed
#SAVE TIFF
tiff("Figures/Figure1_graphics/ClinVar_pLDDT_disorder_PU_chisq.tiff", units="cm", width=10, height=10, res=800)
corrplot(Pathogenicity_pLDDT_PU_chisq$residuals, method = 'color', is.corr = FALSE, col = rev(COL2('RdBu')), 
         cl.pos = 'b', addCoef.col = 'grey50', number.cex = 0.01, col.lim= c(-80, 80))
dev.off()
#SAVE PDF
pdf("Figures/Figure1_graphics/ClinVar_pLDDT_disorder_PU_chisq.pdf", width=4, height=4)
corrplot(Pathogenicity_pLDDT_PU_chisq$residuals, method = 'color', is.corr = FALSE, col = rev(COL2('RdBu')), 
         cl.pos = 'b', addCoef.col = 'grey50', number.cex = 0.01, col.lim= c(-80, 80))
dev.off()
```

```{r Figure1_Graphic_C2}
### Correlations plots - IUPred classification

Pathogenicity_IUPred_chisq$residuals
Pathogenicity_IUPred_chisq$observed
#SAVE TIFF
tiff("Figures/Figure1_graphics/ClinVar_IUPred_disorder_chisq.tiff", units="cm", width=10, height=20, res=800)
corrplot(Pathogenicity_IUPred_chisq$residuals, method = 'color', is.corr  = FALSE, col = rev(COL2('RdBu')),  
         col.lim= c(-70, 70), cl.pos = 'b', addCoef.col = 'grey50', number.cex = 0.01, outline=T, addgrid.col="white")
dev.off()
#SAVE PDF
pdf("Figures/Figure1_graphics/ClinVar_IUPred_disorder_chisq.pdf", width=4, height=8)
corrplot(Pathogenicity_IUPred_chisq$residuals, method = 'color', is.corr  = FALSE, col = rev(COL2('RdBu')),  
         col.lim= c(-70, 70), cl.pos = 'b', addCoef.col = 'grey50', number.cex = 0.01, outline=T, addgrid.col="white")
dev.off()
#corrplot(Pathogenicity_IUPred_chisq$observed,  method = 'color', is.corr   = FALSE, col = rev(COL2('RdBu')), cl.pos = 'b', addCoef.col = 'grey50', outline=T, addgrid.col="white")

Pathogenicity_IUPred_PU_chisq$residuals
Pathogenicity_IUPred_PU_chisq$observed
#SAVE TIFF
tiff("Figures/Figure1_graphics/ClinVar_IUPred_disorder_PU_chisq.tiff", units="cm", width=10, height=20, res=800)
corrplot(Pathogenicity_IUPred_PU_chisq$residuals, method = 'color', is.corr = FALSE, col = rev(COL2('RdBu')),  
         col.lim= c(-70, 70), cl.pos = 'b', addCoef.col = 'grey50', number.cex = 0.01, outline=T, addgrid.col="white")
dev.off()
#SAVE PDF
pdf("Figures/Figure1_graphics/ClinVar_IUPred_disorder_PU_chisq.pdf", width=4, height=4)
corrplot(Pathogenicity_IUPred_PU_chisq$residuals, method = 'color', is.corr = FALSE, col = rev(COL2('RdBu')),  
         col.lim= c(-70, 70), cl.pos = 'b', addCoef.col = 'grey50', number.cex = 0.01, outline=T, addgrid.col="white")
dev.off()
```


```{r Figure1_SupData}
#The reference AM table should be extended to include all ClinVar proteins and not only the one from the DMI predictions
AM_ClinVar_proteins <- read_tsv(file="/Volumes/imb-luckgr/imb-luckgr2/projects/AlphaFold/AFDB_HumanReferenceProteome/AlphaMissense/Chunks/DMI_AM_Complete.tsv", col_names = F)
colnames(AM_ClinVar_proteins) <- c("UniProt_ID", "AA_change","AM_value", "AM_pathogenicity")

AM_ClinVar_proteins <- AM_ClinVar_proteins %>% mutate(AM_pathogenicity=case_when(AM_pathogenicity=="benign" ~ "Benign",
                                                                                 AM_pathogenicity=="ambiguous" ~ "Ambiguous",
                                                                                 AM_pathogenicity=="pathogenic" ~ "Pathogenic"))


ClinVar_mut_dis <- ClinVar_mut_dis %>% mutate(R_variant=amino_acid_map[gsub("^.*?_","",gsub("[0-9]{1,5}","_",aa_change))] ) %>% mutate(AA_change=paste(Residue,Residue_n,R_variant, sep=""))
ClinVar_mut_dis <- left_join(ClinVar_mut_dis, AM_ClinVar_proteins, by=c("UniProt_ID", "AA_change"))
ClinVar_mut_dis$AM_pathogenicity <- ordered(ClinVar_mut_dis$AM_pathogenicity, levels = c("Benign","Ambiguous","Pathogenic"))


AM_ClinVar_proteins %>% filter(AA_change=="R47H" & UniProt_ID=="A0A075B759")
#ClinVar_mut_dis %>% filter(is.na(AM_value))
#ClinVar_mut_dis %>% filter(is.na(AM_pathogenicity)) %>% select(UniProt_ID) %>% unique()
#AM_ClinVar_proteins %>% filter(UniProt_ID=="A0A075B759")
```

```{r Figure1_SuppPlot}
## Needs to be updated to include all ClinVar and not only the DMI proteins mutations
p1 <- ggplot(ClinVar_mut_dis %>% filter(!is.na(AM_pathogenicity)), aes(x=AM_pathogenicity, y=avg_pLDDT, color=as.factor(AM_pathogenicity))) + 
  geom_quasirandom(size=0.5, alpha=0.4) + geom_boxplot(color="black", width=0.25, outlier.alpha = 0.2) +
  ggtitle("AM ClinVar mutations pLDDT") + xlab("AM pathogenicity") + ylab("Residue pLDDT") + 
  theme_classic()  +  scale_color_manual(values=colors_Var) +
  theme(text = element_text(size = 15), legend.position = "none", legend.title = element_text(size=8), 
        legend.text = element_text(size=8), legend.key.size = unit(0.3, 'cm'), axis.text.x = element_text(angle = 30, vjust = 1, hjust=1)) 
#SAVE TIFF
tiff("Figures/Figure1_graphics/Supp_AM_pLDDT.tiff", units="cm", width=10, height=10, res=800)
p1
dev.off()
#SAVE PDF
pdf("Figures/Figure1_graphics/Supp_AM_pLDDT.pdf", width=4, height=4)
p1
dev.off()
p1

p2 <- ggplot(ClinVar_mut_dis%>% filter(!is.na(AM_pathogenicity)), aes(x=AM_pathogenicity, y=avg_IUPred, color=as.factor(AM_pathogenicity))) + 
  geom_quasirandom(size=0.5, alpha=0.4) + geom_boxplot(color="black", width=0.25, outlier.alpha = 0.2) +
  ggtitle("AM ClinVar mutations pLDDT") + xlab("AM pathogenicity") + ylab("Residue IUPred") + 
  theme_classic()  +  scale_color_manual(values=colors_Var) +
  theme(text = element_text(size = 15), legend.position = "none", legend.title = element_text(size=8), 
        legend.text = element_text(size=8), legend.key.size = unit(0.3, 'cm'), axis.text.x = element_text(angle = 30, vjust = 1, hjust=1)) 
#SAVE TIFF
tiff("Figures/Figure1_graphics/Supp_AM_IUPred.tiff", units="cm", width=10, height=10, res=800)
p2
dev.off()
#SAVE PDF
pdf("Figures/Figure1_graphics/Supp_AM_IUPred.pdf", width=4, height=4)
p2
dev.off()
p2

```


```{r Figure1_Graphics_bin}
rm(Pathogenicity_pLDDT_table, Pathogenicity_pLDDT_dt, Pathogenicity_pLDDT_chisq, Pathogenicity_pLDDT_PU_dt, Pathogenicity_pLDDT_PU_chisq,
  Pathogenicity_IUPred_table, Pathogenicity_IUPred_dt, Pathogenicity_IUPred_chisq, Pathogenicity_IUPred_PU_dt, Pathogenicity_IUPred_PU_chisq)
rm(p1, p2, plots_title, plots_xlab, plots_ylab)
```

```{r Figure2_Data}
All_DMIs <- read_csv(file="/Volumes/imb-luckgr/Luck_lab_members/Jesus/DMIs_ClinVar/Datasets/All_DMIs-All_mutations/HuRI_BioPlex_lit17_union.csv")
HuRI_DMIs <- All_DMIs %>% filter(Source_HuRI=="1") %>% mutate(ELM_type=gsub("_.*?$","", Elm)) 
```
```{r Figure2_data2}
Scores_json_raw <- read_tsv(file="/Volumes/imb-luckgr/imb-luckgr2/projects/AlphaFold/HuRI_DMI_AF_modelling/Score_files/DMI_model_confidence_all_2.tab", col_names = T, na = "")
Scores_json <- Scores_json_raw %>% filter(rank==1) %>% select(DMI,model, score)
Scores_json$Model <- gsub("_multimer_v3_pred_0","",gsub("model_","",Scores_json$model))
Scores_json <- Scores_json %>% select(-model)

HuRI_DMI_scores <- HuRI_DMIs %>% select(intx_ID, SLiMProtein, Accession, SLiMMatch, DomainProtein, DomainID1, DomainMatch1, DMIMatchScore)

scores_count <- tibble(bin=seq(from = 0, to = 1, by = 0.05), count=0)
cc_v <- c()
for(i in seq(from = 0, to = 1, by = 0.05)){
  cc <- HuRI_DMI_scores %>% filter(DMIMatchScore>=i) %>% nrow()
  cc_v <- c(cc_v, cc)
}
scores_count$count <-cc_v 
```

```{r Figure2_Graphic_C}
p1 <- ggplot(scores_count, aes(x=bin, y=count)) +  geom_line() + 
  annotate(geom="text", label="0.7", x=0.78, y=100000, size=5, color="red")+ 
  geom_vline(xintercept = 0.7, size=0.5, color="red") + 
  ggtitle("HuRI DMI scores") + xlab("DT score") + ylab("DMI count") + 
  theme_classic() + theme(text = element_text(size = 20))+ 
  scale_y_continuous(labels = scales::comma) 

# SAVE TIFF
tiff("Figures/Figure2_graphics/DMIScore_cummulative.tiff", units="cm", width=10, height=8, res=800)
p1
dev.off()

# SAVE PDF
pdf("Figures/Figure2_graphics/DMIScore_cummulative.pdf", width=4, height=3)
p2
dev.off()


p1 + geom_point() +
  annotate(geom="text", label="Step = 0.05", x=0.2, y=4000, size=3.5)+
  geom_text(aes(label = count), vjust = -1, hjust = -0.2, size = 3) 


```

```{r Figure2_Graphic_D}
p1 <- ggplot(HuRI_DMIs, aes(y=DMIMatchScore, x = ELM_type, color = ELM_type)) + geom_quasirandom(size=0.1, alpha=0.5) + #geom_beeswarm(corral = "wrap", alpha=0.2, size=0.1) + 
  geom_boxplot(color="black", width=0.15, lwd=0.4, outlier.size = 1, outlier.alpha = 0.5) + 
  geom_hline(yintercept = 0.7, color="black") +
  ggtitle("HuRi DMIs") +  xlab("ELM type") + ylab("DMI score") + 
  scale_color_manual(values=colors_ELMtypes) +
  theme_classic() + theme(text = element_text(size = 18), legend.position="none")

# SAVE TIFF
tiff("Figures/Figure2_graphics/HuRI_DMI_Scores.tiff", units="cm", width=12, height=9, res=800)
p1
dev.off()
# SAVE PDF
pdf("Figures/Figure2_graphics/HuRI_DMI_Scores.pdf", width=4, height=3)
p1
dev.off()

p1

p2 <- ggplot(HuRI_DMIs %>% filter(DMIMatchScore >= 0.7), aes(x = ELM_type, fill = ELM_type)) + geom_bar(width = 0.5) + 
  ggtitle("HuRi DMIs") +  xlab("ELM type") + ylab("DMI number") + 
  scale_fill_manual(values=colors_ELMtypes) + 
  theme_classic() + theme(text = element_text(size = 18), legend.position="none") + 
  scale_y_continuous(labels = scales::comma, limits = c(0,7000)) 

# SAVE TIFF
tiff("Figures/Figure2_graphics/HuRI_DMI_higScore.tiff", units="cm", width=11, height=8, res=800)
p2
dev.off()

# SAVE PDF
pdf("Figures/Figure2_graphics/HuRI_DMI_higScore.pdf", width=4, height=3)
p2
dev.off()

p2
p2 + geom_text(stat='count', aes(label=format(after_stat(count), big.mark=",")), vjust=-2, size=3) +
  geom_text(stat='prop', vjust=-0.25, size=3) 


p3 <- ggplot(HuRI_DMIs %>% filter(DMIMatchScore >= 0.7) %>% select(intx_ID, ELM_type) %>% unique(), aes(x = ELM_type, fill = ELM_type)) + 
  geom_bar(width = 0.5) + 
  ggtitle("HuRi DMI PPIs") +  xlab("ELM type") + ylab("PPI number") + 
  scale_fill_manual(values=colors_ELMtypes) +  
  theme_classic() + theme(text = element_text(size = 18), legend.position="none") + 
  scale_y_continuous(labels = scales::comma, limits = c(0,2000)) 

# SAVE TIFF
tiff("Figures/Figure2_graphics/HuRI_DMI_higScore_PPI.tiff", units="cm", width=11, height=8, res=800)
p3
dev.off()

# SAVE PDF
pdf("Figures/Figure2_graphics/HuRI_DMI_higScore_PPI.pdf", width=4, height=3)
p3
dev.off()
p3
p3 + geom_text(stat='count', aes(label=format(after_stat(count), big.mark=",")), vjust=-2, size=3) +
  geom_text(stat='prop', vjust=-0.25, size=3) 


```
```{r Figure2_Supp_Data}
elm_instances <- read_tsv(file="/Volumes/imb-luckgr/Luck_lab_members/Jesus/DMIs_ClinVar/Datasets/ELM_Interacting_Regions_instances.tsv", col_names = T)
elm_instances <- elm_instances %>% filter(motif_protein_species=="Homo sapiens" & curators_instance_assessment=="true positive") %>% select(ELM_Class, motif_protein_uniprot_accession, motif_start_residue_number, motif_end_residue_number, domain_protein_uniprot_accession)
elm_instances$SLiMMatch <- paste(elm_instances$motif_start_residue_number, elm_instances$motif_end_residue_number, sep="-")
elm_instances <- elm_instances %>% select(-motif_start_residue_number, -motif_end_residue_number)
elm_instances$ELM_instance <- "1"
colnames(elm_instances)[c(1:3)] <- c("Elm", "SLiMProtein", "DomainProtein")
elm_instances

DMI_ELM_instances <- HuRI_DMIs %>% filter(DMIMatchScore >= 0.7) %>% select(intx_ID, SLiMProtein, Accession, Elm, SLiMMatch, DomainProtein, DomainID1, DomainName1, DomainMatch1, DMIMatchScore, ELM_type)

DMI_ELM_instances <- left_join(DMI_ELM_instances, elm_instances) 
DMI_ELM_instances <- DMI_ELM_instances %>% mutate(ELM_instance=case_when(is.na(ELM_instance) ~ "0", TRUE ~  ELM_instance))

DMI_ELM_instances %>% count(ELM_instance)
DMI_ELM_instances %>% filter()

# 
# left_join(All_DMIs, elm_instances) %>% count(ELM_instance)
# left_join(HuRI_DMIs, elm_instances) %>% count(ELM_instance)
# left_join(DMI_ELM_instances, elm_instances) %>% count(ELM_instance)
# Only 31 high confidence HuRI predicted DMIs correspond to motif-domain ELM instaces 
# Reason might include any/some of the following: 
### DMI pair is not on HuRI
### DMI doesn't have a high score  
### The whole predictions only have around 7k human proteins, high-scored ones only 1.4 K
### 
# 
# left_join(DMI_ELM_instances, elm_instances, by = c("Elm", "SLiMProtein", "SLiMMatch"))  %>% count(ELM_instance)
# elm_instances %>% filter(Elm=="DOC_ANK_TNKS_1")
# DMI_ELM_instances %>% filter(Elm=="DOC_ANK_TNKS_1" & SLiMProtein=="Q7Z6K5") #456-465
# All_DMIs %>% filter(Elm=="DOC_ANK_TNKS_1" & SLiMProtein=="Q7Z6K5")

DMI_ELM_classes <- HuRI_DMIs %>% filter(DMIMatchScore >= 0.7) %>% select(Accession, Elm, ELM_type) %>% unique()

```

```{r Figure2_Supp_Graphic}
p1 <- ggplot(DMI_ELM_classes, aes(x = ELM_type, fill = ELM_type)) + 
  geom_bar( width = 0.5) + 
  ggtitle("HuRi DMIs - Classes") +  xlab("ELM type") + ylab("Class number") + 
  scale_fill_manual(values=colors_ELMtypes) + ylim(0, 102) +  
  theme_classic() + theme(text = element_text(size = 18), legend.position="none")

# SAVE TIFF
tiff("Figures/Figure2_graphics/HuRI_DMI_highScore_Classes.tiff", units="cm", width=10, height=8, res=800)
p1
dev.off()

# SAVE PDF
pdf("Figures/Figure2_graphics/HuRI_DMI_highScore_Classes.pdf", width=4, height=3)
p1
dev.off()


p1
p1 + geom_text(stat='count', aes(label=format(after_stat(count), big.mark=",")), vjust=-2, size=3) +
  geom_text(stat='prop', vjust=-0.25, size=3) 

```

```{r Figure2_Graphics_bin}
rm(DMI_ELM_classes, DMI_ELM_instances, elm_instances)
rm(p1, p2, p3)
```

```{r Figure3_Data}
HURI_ClinVar_mutation <- read_csv(file="/Volumes/imb-luckgr/Luck_lab_members/Jesus/DMIs_ClinVar/Datasets/HuRI_DMIs-ClinVar_mutations/DMI_human_HuRI_overlap_clinvar_2023_release.csv")
HURI_ClinVar_mutation$fragment_type <- toTitleCase(HURI_ClinVar_mutation$fragment_type)
HURI_ClinVar_mutation$pathogenicity <- toTitleCase(HURI_ClinVar_mutation$pathogenicity)
HURI_ClinVar_mutation <-  HURI_ClinVar_mutation %>% mutate(fragment_type=case_when(fragment_type=="Slim" ~ "Motif", TRUE ~ fragment_type))

HURI_ClinVar_mut_motif <- HURI_ClinVar_mutation %>% filter(fragment_type=="Motif") %>% select(fragment_protein, fragment_id, fragment_pos, pathogenicity) %>% rename(Accession=fragment_id)
HURI_ClinVar_mut_motif <- left_join(HURI_ClinVar_mut_motif, DMI_ELM_classes, by="Accession")
```

```{r Figure3_Data2}
HuRi_DMI <- read_csv(file="/Volumes/imb-luckgr/Luck_lab_members/Jesus/DMIs_ClinVar/Datasets/HuRI_DMIs-ClinVar_mutations/HuRI_human_highScores.csv")

HURI_ClinVar_DMI <- HuRi_DMI %>% filter(SLiMProtein %in% HURI_ClinVar_mutation$fragment_protein | DomainProtein %in% HURI_ClinVar_mutation$fragment_protein)
```

```{r Figure3_Data2_DMI_VariantCount}
HURI_ClinVar_mutation_count_DMI <- HURI_ClinVar_mutation %>% count(fragment_protein,fragment_id, fragment_pos, pathogenicity) %>% pivot_wider(names_from = pathogenicity, values_from = n, values_fill = 0)

HURI_ClinVar_DMI_mut_count_DMI <- HURI_ClinVar_DMI %>% select(intx_ID, DomainProtein, DomainID1, DomainMatch1, SLiMProtein, Accession, SLiMMatch) %>% rename(fragment_protein=SLiMProtein, fragment_id=Accession, fragment_pos=SLiMMatch)

HURI_ClinVar_DMI_mut_count_DMI <- left_join(HURI_ClinVar_DMI_mut_count_DMI, HURI_ClinVar_mutation_count_DMI, by=c("fragment_protein", "fragment_id", "fragment_pos")) %>% mutate_if(is.numeric,coalesce,0) %>% rename(SLiMProtein=fragment_protein, Accession=fragment_id, SLiMMatch=fragment_pos) %>% rename(fragment_protein=DomainProtein, fragment_id=DomainID1, fragment_pos=DomainMatch1)

HURI_ClinVar_DMI_mut_count_DMI <- left_join(HURI_ClinVar_DMI_mut_count_DMI, HURI_ClinVar_mutation_count_DMI, by=c("fragment_protein", "fragment_id", "fragment_pos")) %>% rename(DomainProtein=fragment_protein, DomainID1=fragment_id, DomainMatch1=fragment_pos)

## Avoid counting twice when there are homotypic interactions
HURI_ClinVar_DMI_mut_count_DMI <- HURI_ClinVar_DMI_mut_count_DMI %>% mutate(Benign = Benign.x + Benign.y) %>%
  mutate(Uncertain = Uncertain.x + Uncertain.y) %>% mutate(Conflicting = Conflicting.x + Conflicting.y) %>%
  mutate(Pathogenic = Pathogenic.x + Pathogenic.y)


HURI_ClinVar_DMI_mut_count_DMI_long <- HURI_ClinVar_DMI_mut_count_DMI %>% select(intx_ID, DomainProtein, DomainID1, DomainMatch1, SLiMProtein, Accession, SLiMMatch, Benign, Conflicting, Pathogenic, Uncertain) %>% pivot_longer(names_to = "pathogenicity", cols = Benign:Uncertain) %>% filter(value>0) %>% unique()

```

```{r Figure3_Data2_PPI_VariantCount}
HURI_ClinVar_mutation_count <- HURI_ClinVar_mutation %>% count(fragment_protein,pathogenicity) %>% pivot_wider(names_from = pathogenicity, values_from = n, values_fill = 0)

HURI_ClinVar_DMI_mut_count <- HURI_ClinVar_DMI %>% select(intx_ID, SLiMProtein,DomainProtein) %>% rename(fragment_protein=SLiMProtein)

HURI_ClinVar_DMI_mut_count <- left_join(HURI_ClinVar_DMI_mut_count,HURI_ClinVar_mutation_count, by="fragment_protein") %>% mutate_if(is.numeric,coalesce,0) %>% rename(SLiMProtein=fragment_protein) %>% rename(fragment_protein=DomainProtein)

HURI_ClinVar_DMI_mut_count <- left_join(HURI_ClinVar_DMI_mut_count,HURI_ClinVar_mutation_count, by="fragment_protein") %>% rename(DomainProtein=fragment_protein)

## Avoid counting twice when there are homotypic interactions
HURI_ClinVar_DMI_mut_count <- HURI_ClinVar_DMI_mut_count %>% 
  mutate(benign=case_when(SLiMProtein==DomainProtein ~  Benign.x, TRUE ~ Benign.x + Benign.y))  %>% 
  mutate(uncertain=case_when(SLiMProtein==DomainProtein ~  Uncertain.x, TRUE ~ Uncertain.x + Uncertain.y)) %>% 
  mutate(conflicting=case_when(SLiMProtein==DomainProtein ~ Conflicting.x, TRUE ~ Conflicting.x + Conflicting.y)) %>% 
  mutate(pathogenic=case_when(SLiMProtein==DomainProtein ~  Pathogenic.x, TRUE ~ Pathogenic.x + Pathogenic.y))


HURI_ClinVar_DMI_mut_count_long <- HURI_ClinVar_DMI_mut_count %>% select(intx_ID, benign,conflicting , pathogenic, uncertain) %>% pivot_longer(names_to = "pathogenicity", cols = benign:uncertain) %>% filter(value>0) %>% unique()
HURI_ClinVar_DMI_mut_count_long$pathogenicity <- toTitleCase(HURI_ClinVar_DMI_mut_count_long$pathogenicity)

HURI_ClinVar_DMI_mut_count_long_B <- HURI_ClinVar_DMI_mut_count_long %>% filter(pathogenicity=="Benign") %>% select(intx_ID) %>% unique() %>% unlist()
HURI_ClinVar_DMI_mut_count_long_C <- HURI_ClinVar_DMI_mut_count_long %>% filter(pathogenicity=="Conflicting") %>% select(intx_ID) %>% unique() %>% unlist()
HURI_ClinVar_DMI_mut_count_long_P <- HURI_ClinVar_DMI_mut_count_long %>% filter(pathogenicity=="Pathogenic") %>% select(intx_ID) %>% unique() %>% unlist()
HURI_ClinVar_DMI_mut_count_long_U <- HURI_ClinVar_DMI_mut_count_long %>% filter(pathogenicity=="Uncertain") %>% select(intx_ID) %>% unique() %>% unlist()

HURI_ClinVar_DMI_PPI_list <- list(Benign = HURI_ClinVar_DMI_mut_count_long_B, 
                                  Conflicting = HURI_ClinVar_DMI_mut_count_long_C, 
                                  Pathogenic = HURI_ClinVar_DMI_mut_count_long_P, 
                                  Uncertain = HURI_ClinVar_DMI_mut_count_long_U) 
length(HURI_ClinVar_DMI_mut_count_long_P)
```


```{r Plot3_Graphic_A}
plots_title <- "DMI - Pathogenicity mutations"
plots_xlab <- "Pathogenicity"
plots_ylab <- "Mutation number per DMI"

p1 <- ggplot(HURI_ClinVar_DMI_mut_count_DMI_long, aes(x=pathogenicity, y=value, color=pathogenicity)) + geom_boxplot(width=0.25)+
  ggtitle(plots_title) +  xlab(plots_xlab) + ylab(plots_ylab) + 
  theme_classic() + scale_color_manual(values=colors_Var) + labs(color = "Pathogenicity") +
  theme(text = element_text(size = 20), axis.title.x=element_blank())
p1
p1 + ylim(0,25)

plots_title <- "DMI with at least 1 mutation"
plots_xlab <- "Pathogenicity"
plots_ylab <- "DMI number"

p2 <- ggplot(HURI_ClinVar_DMI_mut_count_DMI_long, aes(x=pathogenicity, fill=pathogenicity)) + geom_bar( width = 0.5) +
  ggtitle(plots_title) +  xlab(plots_xlab) + ylab(plots_ylab) + 
  theme_classic() + scale_fill_manual(values=colors_Var) + labs(fill = "Pathogenicity") +
  theme(text = element_text(size = 20), legend.position = "none", 
        axis.title.x=element_blank(), axis.text.x = element_text(angle = 30, vjust = 1, hjust=1)) + 
  scale_y_continuous(labels = scales::comma, limits = c(0,10500)) 

# SAVE TIFF
tiff("Figures/Figure3_graphics/HuRI_DMIs_OneMutation.tiff", units="cm", width=10, height=10, res=800)
p2
dev.off()

# SAVE PDF
pdf("Figures/Figure3_graphics/HuRI_DMIs_OneMutation.pdf", width=4, height=4)
p2
dev.off()

p2 +  geom_text(aes(label = ..count..), stat = "count", vjust = -1, position = position_dodge(0.9), size = 3.5)

```

```{r Plot3_Graphic_B1}
plots_title <- "PPI - Pathogenicity mutations"
plots_xlab <- "Pathogenicity"
plots_ylab <- "Mutation number per PPI"

p1 <- ggplot(HURI_ClinVar_DMI_mut_count_long, aes(x=pathogenicity, y=value, color=pathogenicity)) + geom_boxplot(width=0.25)+
  ggtitle(plots_title) +  xlab(plots_xlab) + ylab(plots_ylab) + 
  theme_classic() + scale_color_manual(values=colors_Var) + labs(color = "Pathogenicity") +
  theme(text = element_text(size = 20), axis.title.x=element_blank())
p1
p1 + ylim(0,25)

plots_title <- "PPI with at least 1 mutation"
plots_xlab <- "Pathogenicity"
plots_ylab <- "PPI number"

p2 <- ggplot(HURI_ClinVar_DMI_mut_count_long, aes(x=pathogenicity, fill=pathogenicity)) + geom_bar( width = 0.5) +
  ggtitle(plots_title) +  xlab(plots_xlab) + ylab(plots_ylab) + 
  theme_classic() + scale_fill_manual(values=colors_Var) + labs(fill = "Pathogenicity") +
  theme(text = element_text(size = 20), legend.position = "none", 
        axis.title.x=element_blank(), axis.text.x = element_text(angle = 30, vjust = 1, hjust=1)) + 
  scale_y_continuous(labels = scales::comma, limits = c(0,3000)) 

# SAVE TIFF
tiff("Figures/Figure3_graphics/HuRI_PPIs_OneMutation.tiff", units="cm", width=10, height=10, res=800)
p2
dev.off()

# SAVE PDF
pdf("Figures/Figure3_graphics/HuRI_PPIs_OneMutation.pdf", width=4, height=4)
p2
dev.off()

p2 +  geom_text(aes(label = ..count..), stat = "count", vjust = -1, position = position_dodge(0.9), size = 3.5)

```
```{r Plot3_Graphic_B2}
ggvenn(HURI_ClinVar_DMI_PPI_list, fill_color = colors_Var, stroke_size = 0.5, set_name_size = 8, text_size = 6)
p <- ggvenn(HURI_ClinVar_DMI_PPI_list, fill_color = colors_Var, fill_alpha = 0.6, stroke_size = 0.05, set_name_size = 6, text_size = 0.01)

# SAVE TIFF
tiff("Figures/Figure3_graphics/HuRI_PPIs_OneMutation_Venn.tiff", units="cm", width=10, height=8, res=800)
p
dev.off()

# SAVE PDF
pdf("Figures/Figure3_graphics/HuRI_PPIs_OneMutation_Venn.pdf", width=4, height=3)
p
dev.off()
```

```{r Figure3_Graphic_C1}
plots_title <- "DMI - Region mutations"
plots_xlab <- "Protein region"
plots_ylab <- "Mutation proportion"

p1 <- ggplot(HURI_ClinVar_mutation, aes(x=fragment_type , fill=pathogenicity)) + 
  geom_bar(position="fill", width = 0.7, color="black", size=0.4) +
  ggtitle(plots_title) +  xlab(plots_xlab) + ylab(plots_ylab) + 
  theme_minimal() + scale_fill_manual(values=colors_Var) + labs(fill = "Pathogenicity") +
  theme(text = element_text(size = 20), panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), axis.title.x=element_blank())

# SAVE TIFF
tiff("Figures/Figure3_graphics/HuRI_human_ClinVar_mutations_fragment.tiff", units="cm", width=12, height=8, res=800)
p1
dev.off()

# SAVE PDF
pdf("Figures/Figure3_graphics/HuRI_human_ClinVar_mutations_fragment.pdf", width=6, height=4)
p1
dev.off()

p1 +geom_text(aes(label = ..count..), stat = "count", vjust = -0.1,hjust= 1, position = position_fill(0.25), size = 3) +
  geom_text(stat='prop', vjust=-0.1, hjust= -0.1, position = position_fill(0.25), size=3) 


plots_title <- "PPI - Pathogenicity mutations"
plots_xlab <- "Pathogenicity"
plots_ylab <- "Mutation proportion"

p2 <- ggplot(HURI_ClinVar_mutation, aes(x=pathogenicity , fill=fragment_type)) + geom_bar(position = "fill", width = 0.5) +
  ggtitle(plots_title) +  xlab(plots_xlab) + ylab(plots_ylab) + 
  theme_classic() + scale_fill_manual(values=colors_DMI) + labs(fill = "Pathogenicity") +
  theme(text = element_text(size = 20), axis.title.x=element_blank())
p2
p2 + geom_text(aes(label = ..count..), stat = "count", vjust = -0.1,hjust= 1, position = position_fill(0.25), size = 3) +
  geom_text(stat='prop', vjust=-0.1, hjust= -0.1, position = position_fill(0.25), size=3) 
```

```{r Figure3_Graphic_E1}
plots_title <- "DMI - Motif mutations"
plots_xlab <- "Motif category"
plots_ylab <- "Mutation proportion"

p1 <- ggplot(HURI_ClinVar_mut_motif, aes(x=ELM_type , fill=pathogenicity)) + 
  geom_bar(position="fill", width = 0.6, color="black", size=0.4) +
  ggtitle(plots_title) +  xlab(plots_xlab) + ylab(plots_ylab) + 
  theme_minimal() + scale_fill_manual(values=colors_Var) + labs(fill = "Pathogenicity") +
  theme(text = element_text(size = 20), , panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), axis.title.x=element_blank())

# SAVE TIFF
tiff("Figures/Figure3_graphics/HuRI_human_ClinVar_mutations_ELM.tiff", units="cm", width=16, height=8, res=800)
p1
dev.off()

# SAVE PDF
pdf("Figures/Figure3_graphics/HuRI_human_ClinVar_mutations_ELM.pdf", width=8, height=4)
p1
dev.off()

p1
p1 +geom_text(aes(label = ..count..), stat = "count", vjust = -0.1,hjust= 1, position = position_fill(0.25), size = 3) +
  geom_text(stat='prop', vjust=-0.1, hjust= -0.1, position = position_fill(0.25), size=3) 

```

```{r Figure3_Data_Mutations_fragment_tables}
Fragment_contingency_tb <- data.frame(motif=c(0,0,0,0),
                                  domain=c(0,0,0,0),
                                  other=c(0,0,0,0),
                                  total=c(0,0,0,0))
rownames(Fragment_contingency_tb) <- c(" benign", "conflicting", "pathogenic", "uncertain")

Fragment_contingency_tb$motif <- HURI_ClinVar_mutation %>% filter(fragment_type=="Motif") %>% select(pathogenicity) %>% table() %>% as.vector()
Fragment_contingency_tb$domain <- HURI_ClinVar_mutation %>% filter(fragment_type=="Domain") %>% select(pathogenicity) %>% table() %>% as.vector()

DMI_proteins <- HURI_ClinVar_mutation %>% select(fragment_protein) %>% unique() %>% unlist()
Fragment_contingency_tb$total <- ClinVar_mutations %>% filter(uniprot_id %in% DMI_proteins) %>% select(pathogenicity) %>% table() %>% as.vector()
Fragment_contingency_tb$other <- Fragment_contingency_tb$total - Fragment_contingency_tb$motif - Fragment_contingency_tb$domain
Fragment_contingency_tb


Motif_simple_tb <- as.data.frame(Fragment_contingency_tb[c(1,3),1])
colnames(Motif_simple_tb) <- "motif"
Motif_simple_tb$non_motif <- unlist(Fragment_contingency_tb[c(1,3),2] + Fragment_contingency_tb[c(1,3),3])
row.names(Motif_simple_tb) <- c("benign", "pathogenic")
Motif_simple_tb

Domain_simple_tb <- as.data.frame(Fragment_contingency_tb[c(1,3),2])
colnames(Domain_simple_tb) <- "domain"
Domain_simple_tb$non_domain <- unlist(Fragment_contingency_tb[c(1,3),1] + Fragment_contingency_tb[c(1,3),3])
row.names(Domain_simple_tb) <- c("benign", "pathogenic")
Domain_simple_tb

Fragment_contingency_dt <- as.table(as.matrix(Fragment_contingency_tb[,1:3]))
Fragment_contingency_chisq <- chisq.test(Fragment_contingency_dt)
```

```{r Figure3_Graphic_C2}
corrplot(Fragment_contingency_chisq$residuals, method = 'color', is.cor = FALSE,col = rev(COL2('RdBu')), col.lim= c(-35,35), cl.pos = 'b', addCoef.col = 'grey50', outline=T, addgrid.col="white")

# SAVE TIFF
tiff("Figures/Figure3_graphics/DMI_fragment_mutation_enrichment.tiff", units="cm", width=10, height=20, res=800)
corrplot(Fragment_contingency_chisq$residuals, method = 'color', is.cor = FALSE,col = rev(COL2('RdBu')), col.lim= c(-35, 35), cl.pos = 'b', addCoef.col = 'grey50', number.cex = 0.01, outline=T, addgrid.col="white")
dev.off()

# SAVE PDF
pdf("Figures/Figure3_graphics/DMI_fragment_mutation_enrichment.pdf", width=4, height=8)
corrplot(Fragment_contingency_chisq$residuals, method = 'color', is.cor = FALSE, col = rev(COL2('RdBu')), col.lim= c(-35, 35), cl.pos = 'b', addCoef.col = 'grey50', number.cex = 0.01, outline=T, addgrid.col="white")
dev.off()

round(Fragment_contingency_chisq$observed,2)
```

```{r Figure4_Graph_A_draft}
BRET_pairs_edges <- c("CALML3", "IQCB1","CALM1", "IQCB1","MNS1","IQCB1",
                      "LITAF","WWOX", "CPSF6","WWOX", "DAZAP2","WWOX",
                      "SNRPC","WWOX", "HOXA1","WWOX", "CSNK2B","WWOX",
                      "TRAPPC2L","REPS1", "NUMB","REPS1", 
                      "FAM167A","PPP3CA", "PPP3R2","PPP3CA",
                      "DMRTB1","CTBP1", "IKZF1","CTBP1", "CTBP2","CTBP1", 
                      "MYD88","SPOP", "RXRB","SPOP")
BRET_pairs_ig <- make_graph(edges = BRET_pairs_edges, directed = T)

V(BRET_pairs_ig)

#Domain-Motif colours
V(BRET_pairs_ig)$color <- c("#00FF00","grey","#00FF00","#00FF00", #IQCB1
                          "#00FF00","grey","#00FF00","#00FF00","#00FF00","#00FF00","#00FF00", #WWOX
                          "#00FF00","grey","#00FF00", #REPS1
                          "#00FF00","grey","#00FF00", #PPP3CA
                          "#00FF00","grey","#00FF00","#00FF00", #CTBP1
                          "#00FF00","grey","#00FF00") #SPOP


#Motif type colours
E(BRET_pairs_ig)$color <-  c("#3B6FB6", "#3B6FB6", "#3B6FB6",
                             "#3B6FB6", "#3B6FB6", "#3B6FB6", "#3B6FB6","#3B6FB6", "#3B6FB6",
                             "#3B6FB6", "#3B6FB6", 
                             "#F49E17", "#F49E17",
                             "#3B6FB6", "#3B6FB6","#3B6FB6",
                             "#3B6FB6", "#3B6FB6")

#Control and candidate colours
E(BRET_pairs_ig)$color <-  c("forestgreen", "magenta", "darkgrey",
                             "forestgreen", "magenta", "magenta", "darkgrey","darkgrey", "darkgrey",
                             "magenta", "forestgreen", 
                             "magenta", "darkgrey",
                             "magenta", "forestgreen", "darkgrey",
                             "darkgrey", "magenta")



#E(BRET_pairs_ig)$label <- c(3, 4, 6, 2, 2,1,1,1)
#E(BRET_pairs_ig)$weight <- c(1,4)
#E(BRET_pairs_ig)$lty <- c(4,4,1,  4,4,4,1,1,1,   4,4,   4,1,   4,4,1,4,   1,4)  
tiff("Figures/Figure4_graphics/BRET_network.tiff", units="cm", width=12, height=12, res=800)
plot(BRET_pairs_ig, layout = layout_nicely(BRET_pairs_ig), 
     vertex.size = 10, vertex.label.cex=0.01, vertex.label.color="black", vertex.label.dist=4,
     edge.size = 20, edge.label.cex=0.01,  edge.label.color="black", edge.label.dist=10,
     edge.arrow.size=0.5, edge.width=2, main = "BRET network - ALL")

dev.off()

# SAVE PDF
pdf("Figures/Figure4_graphics/BRET_network.pdf", width=5, height=5)
plot(BRET_pairs_ig, layout = layout_nicely(BRET_pairs_ig), 
     vertex.size = 10, vertex.label.cex=0.01, vertex.label.color="black", vertex.label.dist=4,
     edge.size = 20, edge.label.cex=0.01,  edge.label.color="black", edge.label.dist=10,
     edge.arrow.size=0.5, edge.width=2, main = "BRET network - ALL")

dev.off()

plot(BRET_pairs_ig, layout = layout_nicely(BRET_pairs_ig), 
     vertex.size = 10, vertex.label.cex=0.01, vertex.label.color="black", vertex.label.dist=4,
     edge.size = 20, edge.label.cex=0.01,  edge.label.color="black", edge.label.dist=10,
     edge.arrow.size=0.5, edge.width=2, main = "BRET network - ALL")


# CTBP1_DMRTB1,  Q13363_PF00389_O_23_361.Q96MA1_ELME000098_D_174_178
# HuRi_DMI %>% filter(intx_ID=="Q13363_Q96MA1")
# HuRi_DMI %>% filter(SLiMProtein=="Q96MA1") %>% select(ELM_class, SLiMMatch) %>% unique()
```

```{r Figure4_Graph_A_draft}
expanded_cloud <- read_tsv(file="/Volumes/imb-luckgr/Luck_lab_members/Jesus/DMIs_ClinVar/Datasets/BRET_experiments/dalmira_db.NDD_cand_partner_screen_selected_clouds.tsv")
expanded_cloud$selected <- expanded_cloud$NDD_clone * expanded_cloud$partner_clone * as.numeric(expanded_cloud$PPI_detected)
cloud_net <- expanded_cloud %>% select(gene_symbol_NDD, gene_symbol_partner, pair_type, selected) %>% arrange(pair_type, selected)

BRET_pairs_edges <- c(rbind(cloud_net$gene_symbol_partner , cloud_net$gene_symbol_NDD))
BRET_pairs_ig <- make_graph(edges = BRET_pairs_edges, directed = T)

V(BRET_pairs_ig)$color <- c("#00FF00","grey",rep("#00FF00",6), #SPOP
                            "#00FF00","grey",rep("#00FF00",8), #WWOX
                            "#00FF00","grey",rep("#00FF00",5), #IQCB1
                            "#00FF00","grey","#00FF00", #REP1
                            "#00FF00","grey",rep("#00FF00",6), #PPP3CA
                            "grey", "#00FF00",rep("grey",6)) #CTBP1

E(BRET_pairs_ig)$color <-  c("forestgreen", "forestgreen", rep("magenta",5), 
                             "forestgreen", rep("magenta",3), rep("darkgrey",5),
                             "forestgreen", "forestgreen", rep("magenta",4),
                             "magenta", "darkgrey",
                             "magenta", "forestgreen", "darkgrey",
                             "darkgrey", "magenta")

plot(BRET_pairs_ig, layout = layout_nicely(BRET_pairs_ig))

V(BRET_pairs_ig)
cloud_net %>% filter(gene_symbol_NDD=="IQCB1") 
expanded_cloud %>% filter(gene_symbol_NDD=="IQCB1") 
```

```{r Figure4_MOCK}
BRET_PPIs <- c("CALM1_IQCB1", "CALML3_IQCB1", "CTBP1_DMRTB1", "CTBP1_IKZF1", "FAM167A_PPP3CA", "REPS1_TRAPPC2L", "SPOP_MYD88", "SPOP_RXRB", "WWOX_CPSF6", "WWOX_DAZAP2", "WWOX_LITAF")
BRET_heatmap <- tibble(PPI= BRET_PPIs, domain=sample(c(0,1,2,NA), 11,replace=TRUE), 
                       motif=sample(c(0,1,2,NA), 11,replace=TRUE), mutation=sample(c(0,1,2,NA), 11,replace=TRUE))
BRET_heatmap <- BRET_heatmap %>% pivot_longer(names_to = "Validation", cols = domain:mutation) 

x <- LETTERS[1:20]
y <- paste0("var", seq(1,20))
data <- expand.grid(X=x, Y=y)
data$Z <- runif(400, 0, 5)
 
# Heatmap 
p1 <- ggplot(BRET_heatmap, aes(PPI, Validation, fill= value)) + geom_tile() + 
  theme_classic() + theme(text = element_text(size = 15),axis.text.x = element_text(angle = 30, vjust = 1, hjust=1))
p1
```


```{r Figure6_data1}
DMI_AF_metrics <- read_csv(file="/Volumes/imb-luckgr/imb-luckgr2/projects/AlphaFold/HuRI_DMI_AF_modelling/Score_files/DMI_AF_model_metrics.csv")
#Q08209_SM00156_O_10_373.Q96KS9_ELME000237_D_3_9 DOC
#Q08999_PF01857_O_830_1030.Q99708_ELME000007_D_152_169 LIG
DMI_AF_metrics <- DMI_AF_metrics %>% mutate(ELM_type=case_when(DMI_model=="Q08209_SM00156_O_10_373.Q96KS9_ELME000237_D_3_9" ~ "DOC",
                                                               DMI_model=="Q08999_PF01857_O_830_1030.Q99708_ELME000007_D_152_169" ~ "LIG",
                                                               TRUE ~ ELM_type))

DMI_AF_class_table <- DMI_AF_metrics  %>% filter(model_score>=0.6) %>% select(intx_ID, ELM_type) %>% unique()

DMI_AF_metrics %>% filter(model_score>=0.6) %>% nrow()
DMIs_hq <- DMI_AF_metrics %>% filter(model_score>=0.6) %>% select(DMI_model) %>% unlist()
DMI_AF_mutations <- read_tsv(file="/Volumes/imb-luckgr/imb-luckgr2/projects/AlphaFold/HuRI_DMI_AF_modelling/Score_files/DMI_AF_model_metrics_mappedMutations.tsv")
DMI_AF_mut_hq <- DMI_AF_mutations %>% filter(DMI %in% DMIs_hq)
DMI_AF_mut_hq <- DMI_AF_mut_hq %>% mutate(structural_region = case_when(Fragment=="Domain" & Acc_change<(-0.05)  ~ "d_interface",
                                                       Fragment=="Domain" & Acc_change>=-0.05 & Norm_Acc>0.36 ~ "d_surface",
                                                       Fragment=="Domain" & Acc_change>=-0.05 & Norm_Acc<=0.36 ~ "d_buried",
                                                       Fragment=="Motif"  & Acc_change<(-0.05)  ~ "m_interface",
                                                       Fragment=="Motif"  & Acc_change>=-0.05 ~ "m_non_interface",
                                                       TRUE ~ "other" ) )
structural_region <- c("d_interface", "d_buried", "d_surface","m_interface", "m_non_interface")
DMI_AF_mut_hq$structural_region <- ordered(DMI_AF_mut_hq$structural_region, levels = structural_region)
DMI_AF_mut_hq$AM_pathogenicity <- ordered(DMI_AF_mut_hq$AM_pathogenicity, levels = c("AM_benign","AM_ambiguous","AM_pathogenic"))

DMI_AF_mut_hq$Pathogenicity <- toTitleCase(DMI_AF_mut_hq$Pathogenicity)

DMI_AF_mut_hq_table <- DMI_AF_mut_hq %>% filter(structural_region!="other") %>% count(Pathogenicity, structural_region) %>% pivot_wider(names_from = structural_region, values_from = n, values_fill=0 )

DMI_AF_mut_hq_dt <- as.table(as.matrix(DMI_AF_mut_hq_table[,2:6]))
rownames(DMI_AF_mut_hq_dt) <-DMI_AF_mut_hq_table$Pathogenicity
DMI_AF_mut_hq_chisq <- chisq.test(DMI_AF_mut_hq_dt)
DMI_AF_mut_hq_chisq

DMI_AF_mut_hq_PU_dt <- DMI_AF_mut_hq_dt[3:4,]
DMI_AF_mut_hq_PU_chisq <- chisq.test(DMI_AF_mut_hq_PU_dt)
DMI_AF_mut_hq_PU_chisq
```

```{r Figure6_data2}
Model_metrics  <- read_tsv(file="/Volumes/imb-luckgr/imb-luckgr2/projects/AlphaFold/HuRI_DMI_AF_modelling/All_model_metrics.tsv")

Model_metrics_fragments <- read_tsv(file="/Volumes/imb-luckgr/imb-luckgr2/projects/AlphaFold/HuRI_DMI_AF_modelling/All_model_metrics_byFragments.tsv")
Model_metrics_fragments <- Model_metrics_fragments %>% filter(model_score>=0.6)

Model_metrics_motif <- Model_metrics %>% filter(Fragment=="Motif" & model_score>=0.6) %>% select(DMI, aa_code, residue_n, motif_start, pLDDT, Contact_3A, Contact_5A, SC_total_Acc, SC_norm_Acc, Acc_change)

Model_metrics_motif <-  Model_metrics_motif %>% rename(fragment_start=motif_start)
Model_metrics_motif$motif_start <- as.double(gsub("_.*?$","",gsub("^.*?_D_","",Model_metrics_motif$DMI)))
Model_metrics_motif$motif_end <- as.double(gsub("^.*?_","",gsub("^.*?_D_","",Model_metrics_motif$DMI)))
Model_metrics_motif$motif_len <- Model_metrics_motif$motif_end - Model_metrics_motif$motif_start
Model_metrics_motif <- Model_metrics_motif %>% mutate(Motif_region = case_when( residue_n < motif_start~ "Up",
                                                                                residue_n > motif_end~ "Down",
                                                                                TRUE  ~ "Core"))

Model_metrics_motif$Motif_region <- ordered(Model_metrics_motif$Motif_region, levels = c("Up", "Core","Down"))  
Model_metrics_motif$Motif_accession <- gsub("_D_.*?$","",gsub("^.*?_ELM","ELM",Model_metrics_motif$DMI))

ELM_classes <- HuRI_DMIs %>% select(Accession, Elm, ELM_type) %>% unique() %>% rename(Motif_accession=Accession, ELM_class=Elm)

Model_metrics_motif <- left_join(Model_metrics_motif, ELM_classes, by="Motif_accession")


```

```{r Figure6_data3}
Scores_json_raw <- read_tsv(file="/Volumes/imb-luckgr/imb-luckgr2/projects/AlphaFold/HuRI_DMI_AF_modelling/Score_files/DMI_model_confidence_all_2.tab", col_names = T, na = "")
Scores_json <- Scores_json_raw %>% filter(rank==1) %>% select(DMI,model, score)
Scores_json$Model <- gsub("_multimer_v3_pred_0","",gsub("model_","",Scores_json$model))
Scores_json <- Scores_json %>% select(-model)


scores_count <- tibble(bin=seq(from = 0, to = 1, by = 0.05), count=0)
cc_v <- c()
for(i in seq(from = 0, to = 1, by = 0.05)){
  cc <- Scores_json %>% filter(score>=i) %>% nrow()
  cc_v <- c(cc_v, cc)
}
scores_count$count <-cc_v 

```

```{r Figure6_Graph_A}
p1 <- ggplot(scores_count, aes(x=bin, y=count)) +  geom_line() + 
  annotate(geom="text", label="0.6", x=0.68, y=6000, size=5, color="red")+ 
  geom_vline(xintercept = 0.6, size=0.5, color="red") + 
  ggtitle("DMI AF models scores") + xlab("Model confidence") + ylab("Model count") + 
  theme_classic() + theme(text = element_text(size = 20)) + 
  scale_y_continuous(labels = scales::comma, limits = c(0,8000)) 

# SAVE TIFF
tiff("Figures/Figure6_graphics/ModelScore_cummulative.tiff", units="cm", width=10, height=8, res=800)
p1
dev.off()

# SAVE PDF
pdf("Figures/Figure6_graphics/ModelScore_cummulative.pdf", width=4, height=3)
p1
dev.off()

p1 + geom_point() +
  annotate(geom="text", label="Step = 0.05", x=0.2, y=4000, size=3.5)+
  geom_text(aes(label = count), vjust = -1, hjust = -0.2, size = 3) 
  

```

```{r Figure6_Graph_B1}
plots_title <- "Highscored DMI by category"
plots_xlab <- "ELM type"
plots_ylab <- "DMI number"

p1 <- ggplot(DMI_AF_metrics  %>% filter(model_score>=0.6), aes(x=ELM_type, fill=ELM_type)) + geom_bar(width = 0.5) +
  ggtitle(plots_title) +  xlab(plots_xlab) + ylab(plots_ylab) + 
  theme_classic() + scale_fill_manual(values=colors_ELMtypes[c(1:4,6)]) + labs(fill = "ELM type") +
  theme(text = element_text(size = 20), legend.position = "none", axis.title.x=element_blank())  + 
  scale_y_continuous(labels = scales::comma, limits = c(0,2600)) 

# SAVE TIFF
tiff("Figures/Figure6_graphics/AF_high_DMIs.tiff", units="cm", width=10, height=8, res=800)
p1
dev.off()

# SAVE PDF
pdf("Figures/Figure6_graphics/AF_high_DMIs.pdf", width=4, height=3)
p1
dev.off()

p1 +  geom_text(aes(label = ..count..), stat = "count", vjust = -1, position = position_dodge(0.9), size = 3.5)
```

```{r Figure6_Graph_B2}
plots_title <- "PPI with at least 1 DMI category"
plots_xlab <- "ELM type"
plots_ylab <- "PPI number"

p1 <- ggplot(DMI_AF_class_table, aes(x=ELM_type, fill=ELM_type)) + geom_bar(width = 0.5) +
  ggtitle(plots_title) +  xlab(plots_xlab) + ylab(plots_ylab) + 
  theme_classic() + scale_fill_manual(values=colors_ELMtypes[c(1:4,6)]) + labs(fill = "ELM type") +
  theme(text = element_text(size = 20), legend.position = "none", axis.title.x=element_blank())  + 
  scale_y_continuous(labels = scales::comma, limits = c(0,1000)) 

# SAVE TIFF
tiff("Figures/Figure6_graphics/AF_high_PPIs.tiff", units="cm", width=10, height=8, res=800)
p1
dev.off()

# SAVE PDF
pdf("Figures/Figure6_graphics/AF_high_PPIs.pdf", width=4, height=3)
p1
dev.off()

p1 +  geom_text(aes(label = ..count..), stat = "count", vjust = -1, position = position_dodge(0.9), size = 3.5)
```

```{r Figure6_Graph_C}
graph_x <- "Fragment"
graph_y <-  "Fragment\naverage pLDDT"

p1 <- ggplot(Model_metrics_fragments %>% filter(Fragment!="C"), aes(x=Fragment, y=avg_pLDDT, color=Fragment)) + 
  geom_quasirandom(size=0.5, alpha=0.5) + geom_boxplot(color="black", na.rm = TRUE, width=0.25, outlier.alpha = 0.5) +
  ggtitle("Fragment confidence") + xlab(graph_x) + ylab(graph_y) + 
  scale_color_manual(values=colors_DMI) + 
  theme_classic() +  theme(text = element_text(size = 20), legend.position = "none")

graph_y <-  "Fragment\naverage RSA"
p2 <-ggplot(Model_metrics_fragments %>% filter(Fragment!="C"), aes(x=Fragment, y=avg_Acc, color=Fragment)) + 
  geom_quasirandom(size=0.5, alpha=0.5) + geom_boxplot(color="black", na.rm = TRUE, width=0.25, outlier.alpha = 0.5) +
  ggtitle("Fragment accessibility") + xlab(graph_x) + ylab(graph_y) + ylim(0.15,0.7) +
  scale_color_manual(values=colors_DMI) + 
  theme_classic() +  theme(text = element_text(size = 20), legend.position = "none")

# SAVE TIFF
tiff("Figures/Figure6_graphics/Fragments_pLDDT_RSA.tiff", units="cm", width=15, height=10, res=800)
grid.arrange(p1, p2,nrow=1)
dev.off()

# SAVE PDF
pdf("Figures/Figure6_graphics/AF_high_PPIs.pdf", width=7, height=4)
grid.arrange(p1, p2,nrow=1)
dev.off()

grid.arrange(p1, p2,nrow=1)
```
```{r Figure6_Graph_D}
graph_x <- "Motif region"
graph_y <-  "Motif\nresidue pLDDT"

p1 <- ggplot(Model_metrics_motif, aes(x=Motif_region, y=pLDDT, color=Motif_region)) + 
  geom_quasirandom(size=0.5, alpha=0.5) + geom_boxplot(color="black", na.rm = TRUE, width=0.25, outlier.alpha = 0.5) +
  ggtitle("Motif confidence") + xlab(graph_x) + ylab(graph_y) + 
  scale_color_manual(values=c("limegreen","forestgreen","limegreen")) + 
  theme_classic() +  theme(text = element_text(size = 20), legend.position = "none")

# SAVE TIFF
tiff("Figures/Figure6_graphics/Motif_regions_pLDDT.tiff", units="cm", width=10, height=8, res=800)
p1
dev.off()

# SAVE PDF
pdf("Figures/Figure6_graphics/Motif_regions_pLDDT.pdf", width=4, height=3)
p1
dev.off()


graph_y <-  "Motif residue RSA"
p2 <-ggplot(Model_metrics_motif, aes(x=Motif_region, y=SC_norm_Acc, color=Motif_region)) + 
  geom_quasirandom(size=0.5, alpha=0.5) + geom_boxplot(color="black", na.rm = TRUE, width=0.25, outlier.alpha = 0.5) +
  ggtitle("Motif accessibility") + xlab(graph_x) + ylab(graph_y) + 
  scale_color_manual(values=c("limegreen","forestgreen","limegreen")) + 
  theme_classic() +  theme(text = element_text(size = 20), legend.position = "none")

# SAVE TIFF
tiff("Figures/Figure6_graphics/Motif_regions_RSA.tiff", units="cm", width=10, height=8, res=800)
p2
dev.off()

# SAVE PDF
pdf("Figures/Figure6_graphics/Motif_regions_RSA.pdf", width=4, height=3)
p2
dev.off()

graph_y <-  "Motif residue RSA change"
p3 <-ggplot(Model_metrics_motif, aes(x=Motif_region, y=Acc_change, fill=Motif_region)) + 
  geom_boxplot(na.rm = TRUE, width=0.25, outlier.alpha = 0.2) +
  ggtitle("Motif accessibility") + xlab(graph_x) + ylab(graph_y) + 
  scale_fill_manual(values=c("limegreen","forestgreen","limegreen")) + 
  theme_classic() +  theme(text = element_text(size = 15), legend.position = "none")


p1
p2
grid.arrange(p1, p2, nrow=1)
grid.arrange(p1, p2, p3, nrow=1)
```
```{r Figure6_Graph_D2}
graph_x <- "Motif region"
graph_y <-  "Motif residue pLDDT"

p1 <- ggplot(Model_metrics_motif, aes(x=Motif_region, y=pLDDT, fill=ELM_type)) + 
  geom_boxplot(na.rm = TRUE, width=0.25, outlier.alpha = 0.3) +
  ggtitle("Motif confidence") + xlab(graph_x) + ylab(graph_y) + 
  scale_fill_manual(values=colors_ELMtypes) + 
  theme_classic() +  theme(text = element_text(size = 15), legend.position = "none")

graph_y <-  "Motif residue RSA"
p2 <-ggplot(Model_metrics_motif, aes(x=Motif_region, y=SC_norm_Acc, fill=ELM_type)) + 
  geom_boxplot(na.rm = TRUE, width=0.25, outlier.alpha = 0.3) +
  ggtitle("Motif accessibility") + xlab(graph_x) + ylab(graph_y) + 
  scale_fill_manual(values=colors_ELMtypes) + 
  theme_classic() +  theme(text = element_text(size = 15), legend.position = "none")

p3 <-ggplot(Model_metrics_motif, aes(x=Motif_region, y=Acc_change, fill=ELM_type)) + 
  geom_boxplot(na.rm = TRUE, width=0.25, outlier.alpha = 0.3) +
  ggtitle("Motif accessibility") + xlab(graph_x) + ylab(graph_y) + 
  scale_fill_manual(values=colors_ELMtypes) + 
  theme_classic() +  theme(text = element_text(size = 15), legend.position = "none")

p1
p2
p3
```

```{r Figure6_Graph_E}
plots_title <- "Mutation mapped"
plots_xlab <- "structural region "
plots_ylab <- "Mutation proportion"

p1 <- ggplot(DMI_AF_mut_hq %>% filter(structural_region!="other"), aes(x=structural_region, fill=Pathogenicity)) + 
  geom_bar(position="fill", width = 0.6, color="black", size=0.4) +
  ggtitle(plots_title) +  xlab(plots_xlab) + ylab(plots_ylab) + 
  theme_minimal() + scale_fill_manual(values=colors_Var) + labs(fill = "Pathogenicity") +
  theme(text = element_text(size = 20), axis.title.x=element_blank(), panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), axis.text.x = element_text(angle = 30, vjust = 1, hjust=1))  

# SAVE TIFF
tiff("Figures/Figure6_graphics/ClinVar_modelRegion.tiff", units="cm", width=18, height=10, res=800)
p1
dev.off()

# SAVE PDF
pdf("Figures/Figure6_graphics/ClinVar_modelRegion.pdf", width=7, height=4)
p1
dev.off()

p1 +  geom_text(aes(label = ..count..), stat = "count", vjust = -0.1,hjust= 1, position = position_fill(0.25), size = 3) +
  geom_text(stat='prop', vjust=-0.1, hjust= -0.1, position = position_fill(0.25), size=3) 
```

```{r Figure6_Graph_F}
DMI_AF_mut_hq_chisq$residuals
DMI_AF_mut_hq_chisq$observed

# SAVE TIFF
tiff("Figures/Figure6_graphics/ClinVar_modelRegion_chisq.tiff", units="cm", width=8, height=8, res=800)
corrplot(DMI_AF_mut_hq_chisq$residuals, method = 'color', is.corr  = FALSE, col = rev(COL2('RdBu')),  col.lim = c(-15,15),
         cl.pos = 'b', addCoef.col = 'grey50', number.cex = 0.01, outline=T, addgrid.col="white")
dev.off()

# SAVE PDF
pdf("Figures/Figure6_graphics/ClinVar_modelRegion_chisq.pdf", width=4, height=4)
corrplot(DMI_AF_mut_hq_chisq$residuals, method = 'color', is.corr  = FALSE, col = rev(COL2('RdBu')),  col.lim = c(-15,15),
         cl.pos = 'b', addCoef.col = 'grey50', number.cex = 0.01, outline=T, addgrid.col="white")
dev.off()

corrplot(DMI_AF_mut_hq_chisq$residuals, method = 'color', is.corr  = FALSE, col = rev(COL2('RdBu')),  col.lim = c(-15,15),
         cl.pos = 'b', addCoef.col = 'grey50', number.cex = 1, outline=T, addgrid.col="white")

DMI_AF_mut_hq_PU_chisq$residuals
DMI_AF_mut_hq_PU_chisq$observed
corrplot(DMI_AF_mut_hq_PU_chisq$residuals, method = 'color', is.corr  = FALSE, col = rev(COL2('RdBu')), col.lim = c(-15,15),
         cl.pos = 'b', addCoef.col = 'grey50', number.cex = 0.01, outline=T, addgrid.col="white")
```

```{r Figure7_Graph_B}
DMI_AF_mut_hq$AM_pathogenicity <- toTitleCase(gsub("AM_","", DMI_AF_mut_hq$AM_pathogenicity))
DMI_AF_mut_hq$AM_pathogenicity <- ordered(DMI_AF_mut_hq$AM_pathogenicity, levels = c("Benign","Ambiguous","Pathogenic"))

plots_title <- "Alpha Missence mutations"
plots_xlab <- "structural region "
plots_ylab <- "Mutation proportion"

p2 <- ggplot(DMI_AF_mut_hq %>% filter(structural_region!="other"), aes(x=structural_region, fill=AM_pathogenicity)) + 
  geom_bar(position="fill", width = 0.3) +
  ggtitle(plots_title) +  xlab(plots_xlab) + ylab(plots_ylab) + 
  theme_classic() + scale_fill_manual(values=colors_Var) + labs(fill = "Alpha Missense") +
  theme(text = element_text(size = 15), axis.title.x=element_blank(), axis.text.x = element_text(angle = 30, vjust = 1, hjust=1))  
p2 +  geom_text(aes(label = ..count..), stat = "count", vjust = -0.1,hjust= 1, position = position_fill(0.25), size = 3) +
  geom_text(stat='prop', vjust=-0.1, hjust= -0.1, position = position_fill(0.25), size=3) 
  
plots_title <- "Alpha Missence - Uncertain mutations"
p2a <- ggplot(DMI_AF_mut_hq %>% filter(structural_region!="Other" & Pathogenicity=="Uncertain"), aes(x=structural_region, fill=AM_pathogenicity)) + 
  geom_bar(position="fill", width = 0.6, color="black", size=0.4)  +
  ggtitle(plots_title) +  xlab(plots_xlab) + ylab(plots_ylab) + 
  theme_minimal() + scale_fill_manual(values=colors_Var) + labs(fill = "Alpha Missense") +
  theme(text = element_text(size = 18), axis.title.x=element_blank(), panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), axis.text.x = element_text(angle = 30, vjust = 1, hjust=1))  

# SAVE TIFF
tiff("Figures/Figure7_graphics/AM_modelRegion_VUS.tiff", units="cm", width=15, height=8, res=800)
p2a
dev.off()

# SAVE PDF
pdf("Figures/Figure7_graphics/AM_modelRegion_VUS_chisq.pdf", width=7, height=4)
p2a
dev.off()


p2a +  geom_text(aes(label = ..count..), stat = "count", vjust = -0.1,hjust= 1, position = position_fill(0.25), size = 3) +
  geom_text(stat='prop', vjust=-0.1, hjust= -0.1, position = position_fill(0.25), size=3) 

plots_title <- "Alpha Missence - Pathogenic mutations"
p2b <- ggplot(DMI_AF_mut_hq %>% filter(structural_region!="Other" & Pathogenicity=="Pathogenic"), aes(x=structural_region, fill=AM_pathogenicity)) + 
  geom_bar(position="fill", width = 0.3) +
  ggtitle(plots_title) +  xlab(plots_xlab) + ylab(plots_ylab) + 
  theme_classic() + scale_fill_manual(values=colors_Var) + labs(fill = "Alpha Missense") +
  theme(text = element_text(size = 15), axis.title.x=element_blank(), axis.text.x = element_text(angle = 30, vjust = 1, hjust=1))  
p2b +  geom_text(aes(label = ..count..), stat = "count", vjust = -0.1,hjust= 1, position = position_fill(0.25), size = 3) +
  geom_text(stat='prop', vjust=-0.1, hjust= -0.1, position = position_fill(0.25), size=3) 

```


```{r Figure7_sankeys_data}
DMI_AF_mut_mapped <- DMI_AF_mut_hq %>% count(structural_region, Mapped_pathogenicity)

DMI_AF_mut_mapped <- DMI_AF_mut_mapped %>% separate(Mapped_pathogenicity, c("ClinVar", "AlphaMissence"), sep="_") %>% rename(value=n)
DMI_AF_mut_mapped$AlphaMissence <-  paste("AM_", DMI_AF_mut_mapped$AlphaMissence, sep="")

nodes <- data.frame(
  name=c(as.character(DMI_AF_mut_mapped$ClinVar), 
  as.character(DMI_AF_mut_mapped$AlphaMissence)) %>% unique()
)

nodes$name <- ordered(nodes$name, levels = c("B","C","P", "U", "AM_B","AM_A","AM_P"))
nodes$group <- ordered(nodes$name, levels = c("B","C","P", "U", "AM_B","AM_A","AM_P"))

DMI_AF_mut_mapped$ClinVar <- match(DMI_AF_mut_mapped$ClinVar, nodes$name)-1 
DMI_AF_mut_mapped$AlphaMissence <- match(DMI_AF_mut_mapped$AlphaMissence, nodes$name)-1

my_color <- 'd3.scaleOrdinal() .domain(["B", "C", "P", "U", "AM_B", "AM_A", "AM_P"]) .range(["#56B4E9", "#E69F00", "#d52221", "#999999",   "#56B4E9", "#E69F00","#d52221"])'
my_color2 <- 'd3.scaleOrdinal() .domain(["B", "C", "P", "U", "AM_B", "AM_P", "AM_A"]) .range(["#56B4E9", "#E69F00", "#d52221", "#999999",   "#56B4E9", "#d52221", "#E69F00"])'
c("#56B4E9", "#E69F00", "#d52221", "#999999",   "#56B4E9", "#E69F00","#d52221")
regions <- DMI_AF_mut_hq %>% select(structural_region) %>% unique() %>% unlist() %>% as.vector()
```
```{r Figure7_sankeys_Graph_A}
#https://r-graph-gallery.com/322-custom-colours-in-sankey-diagram.html
i <- 1
SK1 <- DMI_AF_mut_mapped %>% filter(structural_region==regions[[i]]) %>% select(-structural_region)
p1 <- sankeyNetwork(Links = SK1, Nodes = nodes, colourScale=my_color,  NodeGroup="group",
              Source = "ClinVar", Target = "AlphaMissence",
              Value = "value", NodeID = "name", sinksRight=FALSE, 
              nodeWidth=50, nodePadding=30, fontSize=0.01, fontFamily = 'Helvetica',
              height = 500, width = 500)
p1

i <- 2
SK2 <- DMI_AF_mut_mapped %>% filter(structural_region==regions[[i]]) %>% select(-structural_region)
p2 <- sankeyNetwork(Links = SK2, Nodes = nodes, colourScale=my_color, NodeGroup="group",
              Source = "ClinVar", Target = "AlphaMissence",
              Value = "value", NodeID = "name", sinksRight=FALSE, 
              nodeWidth=50, nodePadding=30, fontSize=0.01, fontFamily = 'Helvetica',
              height = 500, width = 500)
p2

i <- 3
SK3 <- DMI_AF_mut_mapped %>% filter(structural_region==regions[[i]])# %>% select(-structural_region)
p3 <- sankeyNetwork(Links = SK3, Nodes = nodes, colourScale=my_color, NodeGroup="group",
              Source = "ClinVar", Target = "AlphaMissence",
              Value = "value", NodeID = "name", sinksRight=FALSE, 
              nodeWidth=50, nodePadding=30, fontSize=0.01, fontFamily = 'Helvetica',
              height = 500, width = 500)

saveNetwork(p3, file = 'Figures/Figure7_graphics/Region_domain_interface.html')
p3

i <- 4
SK4 <- DMI_AF_mut_mapped %>% filter(structural_region==regions[[i]]) %>% select(-structural_region)
p4 <- sankeyNetwork(Links = SK4, Nodes = nodes, colourScale=my_color, NodeGroup="group",
              Source = "ClinVar", Target = "AlphaMissence",
              Value = "value", NodeID = "name", sinksRight=FALSE, 
              nodeWidth=50, nodePadding=30, fontSize=0.01, fontFamily = 'Helvetica',
              height = 500, width = 500)
p4

i <- 5
SK5 <- DMI_AF_mut_mapped %>% filter(structural_region==regions[[i]]) %>% select(-structural_region)
p5 <- sankeyNetwork(Links = SK5, Nodes = nodes, colourScale=my_color, NodeGroup="group",
              Source = "ClinVar", Target = "AlphaMissence",
              Value = "value", NodeID = "name", sinksRight=FALSE, 
              nodeWidth=50, nodePadding=30, fontSize=0.01, fontFamily = 'Helvetica',
              height = 500, width = 500)

p5
saveNetwork(p5, file = 'Figures/Figure7_graphics/Region_motif_interface.html')
regions

```

```{r Figure7_Graph_D}
p1 <- ggplot(DMI_AF_mut_hq %>% filter(structural_region=="m_interface" & Mapped_pathogenicity=="U_B"), aes(x=Norm_Acc, y=pLDDT)) + 
  geom_point(alpha=0.3) + geom_hline(yintercept=80, color="red") + geom_vline(xintercept=0.36, color="red") +
  ggtitle("Interfacial motif mutations") +  xlab("RSA") + ylab("Residue pLDDT") + 
  theme_classic() + 
  theme(text = element_text(size = 20))  
p1 

p2 <- ggplot(DMI_AF_mut_hq %>% filter((structural_region=="m_interface" | structural_region=="d_interface") & Mapped_pathogenicity=="U_B"), aes(x=Norm_Acc, y=pLDDT, color=Fragment)) + geom_point(size=0.5, alpha=0.5) + 
  ggtitle("Interfacial motif mutations") +  xlab("RSA") + ylab("Residue pLDDT") + 
  theme_classic() + scale_color_manual(values=colors_DMI) + 
  theme(text = element_text(size = 20))  
p2

p3 <- ggplot(DMI_AF_mut_hq %>% filter((structural_region=="m_interface" | structural_region=="d_interface") & Mapped_pathogenicity=="U_B"), aes(x=Fragment, y=pLDDT, color=Fragment)) + geom_quasirandom(size=1, alpha=0.75) + geom_boxplot(color="black", width=0.2) + 
  ggtitle("Interfacial motif UB mutations") +  xlab("Fragment") + ylab("Residue pLDDT") + 
  theme_classic() + scale_color_manual(values=colors_DMI) + 
  theme(text = element_text(size = 20), legend.position = "none")  
p3

# SAVE TIFF
tiff("Figures/Figure7_graphics/Interfacial_UB_pLDDT_Fragment.tiff", units="cm", width=10, height=10, res=800)
p3
dev.off()

# SAVE PDF
pdf("Figures/Figure7_graphics/Interfacial_UB_pLDDT_Fragment.pdf", width=5, height=3.5)
p3
dev.off()

DMI_AF_mut_hq %>% filter(structural_region=="m_interface" & Mapped_pathogenicity=="U_B" & pLDDT>=80 & Norm_Acc<=0.36) %>% nrow()
```

```{r Figure7_Ontology_mapping}
Domain_UB_proteins <- DMI_AF_mut_hq %>% filter( structural_region=="d_interface" & Mapped_pathogenicity=="U_B") %>% select(Chain_protein) %>% unique()
Motif_UB_proteins <- DMI_AF_mut_hq %>% filter(structural_region=="m_interface" & Mapped_pathogenicity=="U_B") %>% select(Chain_protein) %>% unique()
table(Domain_UB_proteins$Chain_protein %in% Motif_UB_proteins$Chain_protein)
```




```{r Larger_network}
source("/Volumes/imb-luckgr/Luck_lab_members/Jesus/DMIs_ClinVar/Networks/visNetwork_DMI_functions.R")

AF_graph <- mk_PPI_network(DMI_AF_metrics)
BU_graph <- slice_PPI_network(as.vector(UB_proteins),AF_graph)

BU_graph[[1]]$id <- Symbol_map[BU_graph[[1]]$id ]
BU_graph[[2]]$from <- Symbol_map[BU_graph[[2]]$from]
BU_graph[[2]]$to <- Symbol_map[BU_graph[[2]]$to]
BU_graph2 <- mk_igraph_PPI_network(BU_graph)


BU_graph[[1]] %>% count(group) #188 extra proteins
# 311 in total

plot(BU_graph2, layout = layout_nicely(BU_graph2), 
     vertex.size = 7, vertex.label.cex=0.4, vertex.label.color="black", #vertex.label.dist=1, 
     edge.size = 60, edge.label.cex=0.01,  edge.label.color="black", #edge.label.dist=10,
     edge.arrow.size=0.1, edge.width=2, main = "PPI network -")


```


```{r Uncertain_HuRI_essentiality}
HuRI_essentiality <- read_csv(file="/Volumes/imb-luckgr/Luck_lab_members/Jesus/DMIs_ClinVar/Datasets/HuRI_paper_tables/HuRI_Essentiality.csv")
HuRI_essentiality <- HuRI_essentiality %>% select(Gene_symbol, Fitness_effect) %>% rename(Symbol=Gene_symbol)

HuRI_age <- read_csv(file="/Volumes/imb-luckgr/Luck_lab_members/Jesus/DMIs_ClinVar/Datasets/HuRI_paper_tables/HuRI_Age.csv")
HuRI_age <- HuRI_age %>% select(Gene_symbol, Age) %>% rename(Symbol=Gene_symbol)

UB_proteins_sym <- GeneSymbols %>% filter(UniProt %in% UB_proteins)
UB_proteins_sym <-left_join(UB_proteins_sym,HuRI_essentiality)
UB_proteins_sym <-left_join(U0B_proteins_sym,HuRI_age)
UB_proteins_sym <- UB_proteins_sym %>% arrange(-Fitness_effect)

ggplot(UB_proteins_sym %>% filter(!is.na(Fitness_effect)), aes(y=Fitness_effect)) + geom_boxplot(width=0.2)
ggplot(UB_proteins_sym %>% filter(!is.na(Fitness_effect)), aes(y=Age)) + geom_boxplot(width=0.2)

XXX <- DMI_AF_mut_hq %>% select(Chain_protein, residue_n, Pathogenicity, M_number) %>% unique() %>% count(Chain_protein) %>% rename(UniProt=Chain_protein)
XXX <-left_join(XXX,GeneSymbols)
XXX <-left_join(XXX,HuRI_essentiality)
XXX <-left_join(XXX,HuRI_age)

ggplot(XXX %>% filter(!is.na(Fitness_effect)), aes(x=n, y=Fitness_effect)) + geom_point()
ggplot(XXX %>% filter(!is.na(Fitness_effect)), aes(x=n, y=Age)) + geom_point()

XXX <- DMI_AF_mut_hq %>% select(Chain_protein, residue_n, Pathogenicity, M_number) %>% unique() %>% count(Chain_protein, Pathogenicity) %>% rename(UniProt=Chain_protein)
XXX <-left_join(XXX,GeneSymbols)
XXX <-left_join(XXX,HuRI_age)
XXX <-left_join(XXX,HuRI_essentiality) %>% unique()

ggplot(XXX %>% filter(!is.na(Fitness_effect) & Pathogenicity=="pathogenic"), aes(x=n, y=Fitness_effect, color=Pathogenicity)) + geom_point()
ggplot(XXX %>% filter(!is.na(Fitness_effect) ), aes(x=n, y=Age, color=Pathogenicity)) + geom_point()
XXX %>% filter(!is.na(Fitness_effect) & Pathogenicity=="pathogenic" & n>5 & Fitness_effect>1)
```


```{r examples}

UB_proteins
#Q9NZC7_Q99732
#Q08209_Q96KS9
DMI_AF_metrics %>% filter(intx_ID=="O43791_Q99836")
#O43791_Q99836
#All_DMI %>% filter(intx_ID=="O43791_Q99836")
ClinVar_mutations %>% filter(uniprot_id=="P42768") %>%  count(pathogenicity)
```


